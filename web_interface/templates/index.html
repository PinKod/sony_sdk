<!DOCTYPE html>
<html>
<head>
    <title>Camera Control</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .setting { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        label { display: inline-block; width: 200px; }
        select { width: 250px; padding: 5px; }
        #capture-image { max-width: 800px; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Camera Control</h1>
    
    <div id="settings">
        <div class="setting">
            <label for="focus_mode">Focus Mode:</label>
            <select id="focus_mode"></select>
        </div>
        <div class="setting">
            <label for="shoot_mode">Shoot Mode:</label>
            <select id="shoot_mode"></select>
        </div>
        <div class="setting">
            <label for="iso">ISO:</label>
            <select id="iso"></select>
        </div>
        <div class="setting">
            <label for="aperture">Aperture:</label>
            <select id="aperture"></select>
        </div>
        <div class="setting">
            <label for="shutter_speed">Shutter Speed:</label>
            <select id="shutter_speed"></select>
        </div>
        <div class="setting">
            <label for="exposure_bias_compensation">Exposure Bias:</label>
            <select id="exposure_bias_compensation"></select>
        </div>
        <div class="setting">
            <label for="white_balance">White Balance:</label>
            <select id="white_balance"></select>
        </div>
        <div class="setting">
            <label for="jpeg_quality">JPEG Quality:</label>
            <select id="jpeg_quality"></select>
        </div>
        <div class="setting">
            <label for="live_veiw_quality">Live View Quality:</label>
            <select id="live_veiw_quality"></select>
        </div>
    </div>

    <h2>Live View</h2>
    <img id="capture-image" src="/capture" />

    <script>
        const settings = [
            'focus_mode', 'shoot_mode', 'iso', 'aperture', 'shutter_speed',
            'exposure_bias_compensation', 'white_balance', 'jpeg_quality',
            'live_veiw_quality'
        ];

        let currentValues = {};
        let userInteractionTimeout;

        function updateCurrentValues() {
        fetch('/get_current_settings')
            .then(response => response.text())
            .then(xml => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');

                // Update currentValues object
                doc.querySelectorAll('setting').forEach(setting => {
                    const name = setting.getAttribute('name');
                    currentValues[name] = setting.textContent;
                });

                // Update all select elements
                settings.forEach(settingName => {
                    const select = document.getElementById(settingName);
                    if (select && currentValues[settingName]) {
                        // Preserve selection if user is interacting
                        if (!select.matches(':focus')) {
                            select.value = currentValues[settingName];

                            // Add current value to options if missing
                            if (!Array.from(select.options).some(opt => opt.value === currentValues[settingName])) {
                                const opt = document.createElement('option');
                                opt.value = currentValues[settingName];
                                opt.textContent = currentValues[settingName];
                                select.appendChild(opt);
                            }
                        }
                    }
                });
            });
        }   

        function loadSettings() {
            // Load current values
            fetch('/get_current_settings')
                .then(response => response.text())
                .then(xml => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(xml, 'text/xml');
                    doc.querySelectorAll('setting').forEach(setting => {
                        const name = setting.getAttribute('name');
                        currentValues[name] = setting.textContent;
                    });
                    
                    // Load options for each setting
                    settings.forEach(name => loadOptions(name));
                });
        }

        // function loadOptions(settingName) {
        //     fetch(`/get_options/${settingName}`)
        //         .then(response => response.text())
        //         .then(xml => {
        //             const parser = new DOMParser();
        //             const doc = parser.parseFromString(xml, 'text/xml');
        //             const select = document.getElementById(settingName);
        //             select.innerHTML = '';
                    
        //             doc.querySelectorAll('option').forEach(option => {
        //                 const opt = document.createElement('option');
        //                 opt.value = option.textContent;
        //                 opt.textContent = option.textContent;
        //                 select.appendChild(opt);
        //             });
                    
        //             if (currentValues[settingName]) {
        //                 select.value = currentValues[settingName];
        //             }
        //         });
        // }

        function loadOptions(settingName) {
            const select = document.getElementById(settingName);
            const currentValue = currentValues[settingName];

            // Show loading state
            // select.innerHTML = '<option class="loading">Loading options...</option>';
            select.innerHTML = `
                <option class="loading" disabled>Loading... 
                    <svg class="spinner" viewBox="0 0 50 50">
                        <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
                    </svg>
                </option>
            `;


            fetch(`/get_options/${settingName}`)
            .then(response => response.text())
            .then(xml => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(xml, 'text/xml');
                select.innerHTML = '';

                // Create new options
                doc.querySelectorAll('option').forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option.textContent;
                    opt.textContent = option.textContent;
                    select.appendChild(opt);
                });

                // Add current value if missing
                if (currentValue && !select.querySelector(`option[value="${currentValue}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = currentValue;
                    opt.textContent = `${currentValue} (current)`;
                    opt.className = 'option-missing';
                    select.appendChild(opt);
                }

                // Restore selection
                if (currentValue) {
                    select.value = currentValue;
                }
            })
            .catch(() => {
                select.innerHTML = '<option class="loading">Failed to load options</option>';
            });
        }

        function updateSetting(setting, value) {
            const formData = new FormData();
            formData.append('setting', setting);
            formData.append('value', value);
            
            fetch('/set_setting', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => {
                if (!response.ok) {
                    alert('Error updating setting');
                }
            });
        }

        // Set up event listeners
        function initialize() {
            settings.forEach(settingName => {
            const select = document.getElementById(settingName);
            select.innerHTML = '<option class="loading">Loading...</option>';
            select.addEventListener('change', (e) => {
                    updateSetting(settingName, e.target.value);
                });
            });

            // Update options every 2 seconds
            setInterval(() => {
                settings.forEach(name => loadOptions(name));
            }, 5000);

            // Update current values every 1 second
            setInterval(() => {
                updateCurrentValues();
            }, 2000);

            // Faster image refresh (every 33ms ~30fps)
            setInterval(() => {
                const img = document.getElementById('capture-image');
                img.src = `/capture?t=${Date.now()}`;
            }, 33);

            // Initial load
            loadOptions();
            updateCurrentValues();
        }

        // Start when document is ready
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>